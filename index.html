<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>ミズノ スポーツ施設ハザードマップ</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    #map { width: 100%; height: 100vh; }
    .map-legend, .search-box, .filter-panel {
      position: absolute;
      left: 10px;
      z-index: 1000;
      background: white;
      padding: 5px;
      border-radius: 5px;
      box-shadow: 0 0 6px rgba(0,0,0,0.3);
    }
    .map-legend { top: 280px; }
    .search-box { top: 20px; display: flex; gap: 5px; }
    .filter-panel { top: 60px; max-height: 200px; overflow-y: auto; font-size: 14px; }
    .map-legend img { width: 200px; display: block; }
    .city-list { margin-left: 15px; }
    .leaflet-control-scale {
      left: 50% !important;
      transform: translateX(-50%) !important;
      right: auto !important;
      bottom: 10px !important;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="search-box">
    <input type="text" id="searchBox" placeholder="施設名で検索" />
    <button onclick="clearSearch()">Clear</button>
  </div>
  <div class="filter-panel" id="filterPanel"></div>
  <div class="map-legend"><img src="shinsui_legend_popup.png" alt="洪水凡例"></div>
  <script>
    const map = L.map('map', { zoomControl: false }).setView([35.0, 135.0], 5);
    L.control.zoom({ position: 'bottomright' }).addTo(map);
    L.control.scale({ position: 'bottomleft', metric: true, imperial: false }).addTo(map);

    const base = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png', { attribution: "地理院タイル" }).addTo(map);

    const overlays = {};

    const allEvacLayer = L.layerGroup();
    overlays["避難所"] = allEvacLayer;

    const layerControl = L.control.layers(null, overlays).addTo(map);

    function clearSearch() {
      document.getElementById('searchBox').value = '';
      renderMarkers(geoJsonData.features);
    }

    let markerLayer;
    let geoJsonData;
    fetch('mizuno_facilities.geojson')
      .then(res => res.json())
      .then(data => {
        geoJsonData = data;
        renderMarkers(data.features);
        populateFilterPanel(data.features);
      });

    function renderMarkers(features) {
      if (markerLayer) map.removeLayer(markerLayer);
      markerLayer = L.geoJSON({type: "FeatureCollection", features: features}, {
        pointToLayer: function(feature, latlng) {
          const color = feature.properties["ピン色"] === "red" ? "red" : "blue";
          const icon = L.icon({
            iconUrl: color === "red" ? "pin-red.png" : "pin-blue.png",
            iconSize: [32, 32],
            iconAnchor: [16, 32],
            popupAnchor: [0, -32]
          });
          return L.marker(latlng, { icon: icon });
        },
        onEachFeature: function (feature, layer) {
          const props = feature.properties;
          const lat = feature.geometry.coordinates[1];
          const lng = feature.geometry.coordinates[0];
          const popupText = `<b>${props["施設名"]}</b><br>${props["住所"]}<br>${props["電話番号"]}<br><a href="https://www.google.com/maps/@?api=1&map_action=map&center=${lat},${lng}&zoom=18&basemap=satellite" target="_blank">衛星画像で見る</a>`;
          layer.bindPopup(popupText);
        }
      }).addTo(map);
    }

    document.getElementById('searchBox').addEventListener('input', function (e) {
      const keyword = e.target.value.trim();
      if (!geoJsonData) return;
      const filtered = geoJsonData.features.filter(f => f.properties["施設名"].includes(keyword));
      renderMarkers(filtered);
      if (filtered.length > 0) {
        const coords = filtered[0].geometry.coordinates;
        map.setView([coords[1], coords[0]], 14);
      }
    });

    function populateFilterPanel(features) {
      const panel = document.getElementById('filterPanel');
      const grouped = {};
      features.forEach(f => {
        const pref = f.properties["都道府県"];
        const city = f.properties["市町村"];
        if (!grouped[pref]) grouped[pref] = new Set();
        grouped[pref].add(city);
      });
      const prefOrder = [
        "北海道", "青森県", "岩手県", "宮城県", "秋田県", "山形県", "福島県",
        "茨城県", "栃木県", "群馬県", "埼玉県", "千葉県", "東京都", "神奈川県",
        "新潟県", "富山県", "石川県", "福井県", "山梨県", "長野県",
        "岐阜県", "静岡県", "愛知県", "三重県",
        "滋賀県", "京都府", "大阪府", "兵庫県", "奈良県", "和歌山県",
        "鳥取県", "島根県", "岡山県", "広島県", "山口県",
        "徳島県", "香川県", "愛媛県", "高知県",
        "福岡県", "佐賀県", "長崎県", "熊本県", "大分県", "宮崎県", "鹿児島県", "沖縄県"
      ];
      prefOrder.forEach(pref => {
        if (!grouped[pref]) return;
        const prefDiv = document.createElement('div');
        const prefLabel = document.createElement('div');
        prefLabel.textContent = pref;
        prefLabel.style.fontWeight = 'bold';
        prefLabel.style.cursor = 'pointer';
        const cityDiv = document.createElement('div');
        cityDiv.className = 'city-list';
        cityDiv.style.display = 'none';
        Array.from(grouped[pref]).sort().forEach(city => {
          const region = `${pref} ${city}`;
          const id = `chk_${region.replace(/\s/g, '_')}`;
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.id = id;
          checkbox.dataset.region = region;
          const label = document.createElement('label');
          label.htmlFor = id;
          label.textContent = city;
          checkbox.addEventListener('change', filterByRegion);
          const itemDiv = document.createElement('div');
          itemDiv.appendChild(checkbox);
          itemDiv.appendChild(label);
          cityDiv.appendChild(itemDiv);
        });
        prefLabel.addEventListener('click', () => {
          cityDiv.style.display = cityDiv.style.display === 'none' ? 'block' : 'none';
        });
        prefDiv.appendChild(prefLabel);
        prefDiv.appendChild(cityDiv);
        panel.appendChild(prefDiv);
      });
    }

    function filterByRegion() {
      const checkboxes = document.querySelectorAll('#filterPanel input[type=checkbox]:checked');
      const selectedRegions = Array.from(checkboxes).map(cb => cb.dataset.region);
      if (selectedRegions.length === 0) {
        renderMarkers(geoJsonData.features);
        return;
      }
      const filtered = geoJsonData.features.filter(f => selectedRegions.includes(`${f.properties["都道府県"]} ${f.properties["市町村"]}`));
      renderMarkers(filtered);
    }
  </script>
</body>
</html>